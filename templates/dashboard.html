
<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>We Win Algo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root {
      --bg-main: #000000;
      --bg-card: rgba(10, 10, 15, 0.75);
      --primary: #00f0ff;
      --primary-glow: rgba(0, 240, 255, 0.6);
      --danger: #ff2d55;
      --warning: #ff9f1c;
      --success: #00ff9d;
      --text: #e0f7ff;
      --text-muted: #94a3b8;
    }

    body {
      background: var(--bg-main);
      color: var(--text);
      background-image: 
        radial-gradient(circle at 15% 50%, rgba(0, 238, 255, 0.167) 0%, transparent 25%),
        radial-gradient(circle at 85% 30%, rgba(7, 181, 240, 0.215) 0%, transparent 35%);
      background-attachment: fixed;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    .glow-cyan {
      box-shadow: 0 0 20px var(--primary-glow), 0 0 40px rgba(0, 240, 255, 0.25);
    }

    .glow-red {
      box-shadow: 0 0 20px rgba(255, 45, 85, 0.5);
    }

    .glass {
      background: var(--bg-card);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(0, 240, 255, 0.12);
    }

    .btn-glow {
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .btn-glow::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255,255,255,0.15),
        transparent
      );
      transition: 0.6s;
    }

    .btn-glow:hover::before {
      left: 100%;
    }

    .btn-glow:hover {
      transform: translateY(-2px);
    }

    .status-dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      box-shadow: 0 0 10px currentColor;
    }

    tr {
      transition: all 0.2s ease;
    }

    tr:hover {
      background: rgba(0, 240, 255, 0.08);
      transform: translateY(-1px);
    }

    .modal {
      animation: modalPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes modalPop {
      from { opacity: 0; transform: scale(0.85) translateY(40px); }
      to   { opacity: 1; transform: scale(1) translateY(0); }
    }
    @keyframes pulse-slow {
      0%, 100% { opacity: 0.25; transform: scale(1); }
      50%      { opacity: 0.45; transform: scale(1.15); }
    }
    .animate-pulse-slow {
      animation: pulse-slow 12s infinite ease-in-out;
    }
    .delay-1000 {
      animation-delay: 1.5s;
    }
    .tabular-nums { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="min-h-screen">

<!-- TOP BAR -->
<header class="sticky top-0 z-50 glass border-b border-cyan-900/30">
  <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
    <div class="flex items-center gap-5">
      <h1 class="text-3xl font-black tracking-tighter">
        <span class="text-white">ALGO</span>
        <span class="text-cyan-400">EDGE</span>
      </h1>
      <div class="px-3 py-1 rounded-full bg-cyan-950/40 text-cyan-300 text-xs font-medium glow-cyan">
        <i class="fa-solid fa-user-astronaut mr-1.5"></i>{{USERNAME}} ‚Ä¢ {{USER_ID}}
      </div>
    </div>

    <div class="flex items-center gap-4">
      <div id="status-badge" class="flex items-center gap-2 px-4 py-2 rounded-full bg-black/40 border border-cyan-900/30 text-sm font-medium">
        <span class="status-dot bg-gray-500"></span>Zerodha ‚Ä¢ ‚Ä¶
      </div>

      <div id="market-badge" class="flex items-center gap-2 px-4 py-2 rounded-full bg-black/40 border border-cyan-900/30 text-sm font-medium">
        <span class="status-dot bg-gray-500"></span>Market ‚Ä¢ ‚Ä¶
      </div>

      <div id="ws-badge" class="px-4 py-2 rounded-full bg-black/40 border border-cyan-900/30 text-sm font-medium">
        WS ‚Ä¢ ‚Ä¶
      </div>
      
      <div class="flex gap-3">
        <button onclick="openCred()" class="btn-glow px-5 py-2.5 bg-cyan-900/30 hover:bg-cyan-800/50 border border-cyan-600/50 rounded-lg font-medium text-cyan-300 glow-cyan">
          <i class="fa-solid fa-link mr-2"></i>Connect
        </button>

        <button onclick="squareoffAll()" class="btn-glow px-5 py-2.5 bg-amber-900/40 hover:bg-amber-800/50 border border-amber-600/50 rounded-lg font-medium text-amber-300">
          <i class="fa-solid fa-arrows-rotate mr-2"></i>Square All
        </button>

        <button onclick="killSwitch()" class="btn-glow px-6 py-2.5 bg-red-900/50 hover:bg-red-800/60 border border-red-600/60 rounded-lg font-medium text-red-300 glow-red">
          <i class="fa-solid fa-power-off mr-2"></i>KILL
        </button>
      </div>
    </div>
  </div>
</header>

<!-- MAIN CONTENT -->
<main class="max-w-7xl mx-auto px-6 py-10 space-y-12">

  <!-- ALERTS SECTION -->
  <section>
    <h2 class="text-2xl font-bold text-cyan-300 mb-6 flex items-center gap-3">
      <i class="fa-solid fa-bolt-lightning text-yellow-400"></i>
      Live Chartink Alert Signals
    </h2>

    <div class="glass rounded-2xl overflow-hidden shadow-2xl shadow-black/70">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-black/60">
            <tr class="text-cyan-300/90 font-semibold">
              <th class="p-5 text-left">Scan</th>
              <th class="p-5">Time</th>
              <th class="p-5">Symbol</th>
              <th class="p-5">LTP</th>
              <th class="p-5">‚¨Ü UC</th>
              <th class="p-5">‚¨á LC</th>
              <th class="p-5">% Chg</th>
              <th class="p-5">From O</th>
              <th class="p-5">From H</th>
              <th class="p-5">From L</th>
              <th class="p-5">TBQ</th>
              <th class="p-5">TSQ</th>
              <th class="p-5">Buy Vol</th>
              <th class="p-5">Sell Vol</th>
              <th class="p-5 text-center">Trade</th>
            </tr>
          </thead>
          <tbody id="alerts-body" class="divide-y divide-cyan-900/30">
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- LADDER POSITIONS -->
<section>
  <h2 class="text-2xl font-bold text-cyan-300 mb-6 flex items-center gap-3">
    <i class="fa-solid fa-cubes text-cyan-400"></i>
    Active Ladders Positions
  </h2>

  <!-- Overall PnL pill + Total ladders -->
  <div class="mb-4 flex items-center justify-between">
    <div
      id="ladder-pnl-pill"
      class="inline-flex items-center gap-2 px-4 py-2 rounded-full
             bg-emerald-900/20 border border-emerald-600/40
             text-emerald-300 font-semibold shadow shadow-emerald-900/30"
    >
      <i class="fa-solid fa-chart-line"></i>
      <span>Overall PnL</span>
      <span class="text-emerald-200 tabular-nums">‚Ä¢</span>
      <span id="overall-pnl-ladders" class="tabular-nums text-emerald-200">0.00</span>
    </div>

    <div class="text-xs text-slate-500 flex items-center gap-3">
      <span
        id="ladder-count-badge"
        class="inline-flex items-center gap-2 px-3 py-1 rounded-full
               bg-cyan-900/20 border border-cyan-600/30 text-cyan-300"
      >
        <i class="fa-solid fa-layer-group"></i>
        <span>Total Ladders:</span>
        <span id="ladder-count" class="tabular-nums">0</span>
      </span>
    </div>
  </div>

  <!-- Table -->
  <div class="glass rounded-2xl overflow-hidden shadow-2xl shadow-black/70">
    <table class="w-full text-sm">
      <thead class="bg-black/60">
        <tr class="text-cyan-300/90 font-semibold">
          <th class="p-5 text-left">Symbol</th>
          <th class="p-5">Cycle</th>
          <th class="p-5">Leg</th>
          <th class="p-5">Qty</th>
          <th class="p-5">LTP</th>
          <th class="p-5">Avg</th>
          <th class="p-5">Extreme</th>
          <th class="p-5">Next Add</th>
          <th class="p-5">SL</th>
          <th class="p-5">TSL</th>
          <th class="p-5">PnL</th>
          <th class="p-5">Status</th>
          <th class="p-5 text-center">Action</th>
        </tr>
      </thead>

      <tbody id="ladderRows" class="divide-y divide-cyan-900/30">
        <tr>
          <td colspan="13" class="p-16 text-center text-cyan-900/70 italic text-lg">
            No active ladder strategies
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

</main>

<!-- ================= TRADE MODAL ================= -->
<div id="tradeModal" class="fixed inset-0 hidden bg-black/80 backdrop-blur-lg items-center justify-center z-50 modal">
  <div class="glass border border-cyan-800/40 rounded-3xl p-10 w-full max-w-lg shadow-2xl shadow-cyan-950/70 glow-cyan">
    <div class="flex justify-between items-center mb-8">
      <h3 class="text-3xl font-black text-cyan-300 tracking-tight">
        <i class="fa-solid fa-cubes mr-3"></i>‚öôÔ∏è LADDER SETTINGS
      </h3>
      <button onclick="closeTradeModal()" class="text-cyan-500 hover:text-cyan-300 text-2xl transition-colors">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <div class="mb-8 p-4 bg-black/40 rounded-2xl border border-cyan-900/30 text-center">
      <span id="tm-symbol" class="text-2xl font-bold text-cyan-300"></span>
      <span id="tm-side" class="ml-4 px-4 py-2 rounded-full text-lg font-black"></span>
    </div>

    <!-- Form fields with better spacing & labels -->
    <div class="grid grid-cols-2 gap-6 mb-8">
      <div>
        <label class="block text-sm text-cyan-400/80 mb-2 font-medium">Mode</label>
        <select id="ls-mode" class="w-full bg-black/60 border border-cyan-900/50 rounded-xl px-5 py-3 text-white focus:border-cyan-500 focus:ring-2 focus:ring-cyan-600/40">
          <option value="UNIVERSAL">Universal</option>
          <option value="STOCK">Stock Specific</option>
        </select>
      </div>

      <div>
        <label class="block text-sm text-cyan-400/80 mb-2 font-medium">Qty Mode</label>
        <select id="ls-qtymode" class="w-full bg-black/60 border border-cyan-900/50 rounded-xl px-5 py-3 text-white focus:border-cyan-500 focus:ring-2 focus:ring-cyan-600/40">
          <option value="CAPITAL">Capital Based</option>
          <option value="QTY">Fixed Quantity</option>
        </select>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-5 mb-6">
      <div>
        <label class="block text-xs text-slate-400 mb-1.5">Capital (‚Çπ)</label>
        <input id="ls-capital" type="number" value="1000" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-sm"/>
      </div>
      <div>
        <label class="block text-xs text-slate-400 mb-1.5">Quantity</label>
        <input id="ls-qty" type="number" value="1" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-sm"/>
      </div>
    </div>

    <div class="grid grid-cols-3 gap-5 mb-8">
      <div>
        <label class="block text-xs text-slate-400 mb-1.5">Threshold %</label>
        <input id="ls-threshold" type="number" step="0.01" value="1" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-sm"/>
      </div>
      <div>
        <label class="block text-xs text-slate-400 mb-1.5">Stop Loss %</label>
        <input id="ls-sl" type="number" step="0.01" value="1" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-sm"/>
      </div>
      <div>
        <label class="block text-xs text-slate-400 mb-1.5">Trailing %</label>
        <input id="ls-tsl" type="number" step="0.01" value="1" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-sm"/>
      </div>
    <div>
        <label class="block text-xs text-slate-400 mb-1.5">Cycles</label>
        <input id="ls-cycles" type="number" value="1"
          class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-sm"/>
      </div>

      <div>
        <label class="block text-xs text-slate-400 mb-1.5">Max Adds</label>
        <input id="ls-maxadds" type="number" value="2"
          class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2.5 text-sm"/>
      </div>
    </div>

    <div class="flex gap-5 mt-10">
      <button onclick="confirmTrade()" class="flex-1 btn-glow py-4 bg-gradient-to-r from-cyan-600 to-cyan-400 hover:from-cyan-500 hover:to-cyan-300 rounded-2xl font-bold text-lg shadow-2xl shadow-cyan-900/70">
        <i class="fa-solid fa-rocket-launch mr-2"></i>LAUNCH STRATEGY
      </button>
      <button onclick="closeTradeModal()" class="flex-1 py-4 bg-black/60 border border-cyan-900/50 hover:bg-cyan-950/50 rounded-2xl font-medium text-lg">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Toast / Message -->
<div id="msg-box" class="fixed bottom-6 left-1/2 -translate-x-1/2 hidden px-6 py-3 rounded-xl text-sm font-medium shadow-2xl z-50 transition-all duration-300"></div>

<!-- ================= CREDENTIALS MODAL - Professional Style ================= -->
<div id="credModal" class="fixed inset-0 hidden bg-black/75 backdrop-blur-md flex items-center justify-center z-50">
  <div class="bg-[#0f172a] rounded-2xl p-10 w-full max-w-md border border-slate-700/50 shadow-2xl shadow-black/40">

    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
      <h2 class="text-2xl font-semibold text-cyan-400 flex items-center gap-3">
        <i class="fa-solid fa-shield-halved text-cyan-500"></i>
        Zerodha API Credentials
      </h2>
      <button 
        onclick="closeCred()" 
        class="text-slate-400 hover:text-slate-200 transition-colors text-xl"
        title="Close"
      >
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <!-- Description -->
    <p class="text-sm text-slate-400 mb-8 leading-relaxed">
      Securely connect your Zerodha account. 
    </p>

    <!-- Form -->
    <form class="space-y-6">

      <!-- API Key -->
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-2">
          API Key
        </label>
        <div class="relative">
          <input 
            id="api_key" 
            type="password" 
            placeholder="xxxxxxxxxxxxxxxxxxxxxxxx"
            class="w-full bg-slate-900/60 border border-slate-700 rounded-lg px-5 py-3.5 text-slate-200 
                   placeholder:text-slate-600 focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500/30 
                   transition-all duration-200 outline-none"
          />
          <button 
            type="button"
            onclick="toggleVisibility('api_key', this)"
            class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-cyan-400 transition-colors"
            title="Show/Hide"
          >
            <i class="fa-solid fa-eye"></i>
          </button>
        </div>
      </div>

      <!-- API Secret -->
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-2">
          API Secret
        </label>
        <div class="relative">
          <input 
            id="api_secret" 
            type="password" 
            placeholder="xxxxxxxxxxxxxxxxxxxxxxxx"
            class="w-full bg-slate-900/60 border border-slate-700 rounded-lg px-5 py-3.5 text-slate-200 
                   placeholder:text-slate-600 focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500/30 
                   transition-all duration-200 outline-none"
          />
          <button 
            type="button"
            onclick="toggleVisibility('api_secret', this)"
            class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-cyan-400 transition-colors"
            title="Show/Hide"
          >
            <i class="fa-solid fa-eye"></i>
          </button>
        </div>
      </div>

      <!-- Buttons -->
      <div class="flex gap-4 mt-8">
        <button 
          type="button"
          onclick="saveCred()" 
          class="flex-1 bg-cyan-600 hover:bg-cyan-500 text-white font-medium py-3.5 rounded-lg 
                 transition-all duration-200 flex items-center justify-center gap-2 shadow-lg shadow-cyan-900/30"
        >
          <i class="fa-solid fa-floppy-disk"></i>
          Save Credentials
        </button>

        <button 
          type="button"
          onclick="connectZerodha()" 
          class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-medium py-3.5 rounded-lg 
                 transition-all duration-200 flex items-center justify-center gap-2"
        >
          <i class="fa-solid fa-right-to-bracket"></i>
          Login to Kite
        </button>
      </div>
    </form>
  </div>
</div>



<script>
/* ---------- STATE ---------- */
const USER_ID = "{{USER_ID}}";
// ===== Live ladder PnL meta store (for continuous updates) =====
const LADDER_META = {}; 
// ===== recompute overall ladder pnl from live values =====
let overallLive = 0;
for(const s in LADDER_META){
  const m = LADDER_META[s];
  const pnl = calcUnrealizedPnl(m.side, m.qty, m.avg, m.ltp);
  overallLive += pnl;
}
setOverallPnl(overallLive);


// alerts
let subscribed = new Set();
let alertsInterval = null;
let LAST_ALERTS_RENDER = null;   // last JSON signature to avoid rebuild
let ALERT_ROW_KEYS = new Set();  // currently rendered unique keys

// trade modal
let tmSymbol = null;
let tmSide = null;

// ws
let TICK_WS = null;
let WS_READY = false;
let WS_RETRY = 1500;

let TICK_BUFFER = {};
let TICK_FLUSH_TIMER = null;

/* ---------- HELPERS ---------- */
function $(id){ return document.getElementById(id); }

function setWs(ok, txt){
  const b = $("ws-badge");
  b.innerText = txt;
  b.className = "px-3 py-1 text-xs rounded " +
    (ok ? "bg-green-600/20 text-green-400" : "bg-red-600/20 text-red-400");
}

function wsUrl(){
  const p = location.protocol === "https:" ? "wss" : "ws";
  return `${p}://${location.host}/ws/ticks?user_id=${USER_ID}`;
}

function toggleVisibility(inputId, button) {
  const input = document.getElementById(inputId);
  const icon = button.querySelector('i');
  if (input.type === 'password') {
    input.type = 'text';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    input.type = 'password';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
}

// IST time parts
function istHM(){
  const parts = new Intl.DateTimeFormat("en-IN", {
    timeZone: "Asia/Kolkata",
    hour: "2-digit",
    minute: "2-digit",
    hour12: false
  }).formatToParts(new Date());
  let h=0,m=0;
  for(const p of parts){
    if(p.type==="hour") h = parseInt(p.value,10);
    if(p.type==="minute") m = parseInt(p.value,10);
  }
  return {h,m};
}

/**
 * Freeze window: market close ke baad 15:31 -> next day 09:00 tak
 *  - 15:31-23:59 => freeze
 *  - 00:00-08:59 => freeze
 *  - 09:00-15:30 => allow
 */
function isAlertFreezeWindow(){
  const {h,m} = istHM();
  if(h < 9) return true;
  if(h > 15) return true;
  if(h === 15 && m >= 31) return true;
  return false;
}

/* ---------- SESSION + STATUS ---------- */
async function checkSession(){
  const r = await fetch("/api/zerodha-status");
  if(!r.ok){
    alert("Login first!");
    window.location.href = "/";
    return false;
  }
  return true;
}

async function refreshStatus(){
  const badge = $("status-badge");
  try {
    const res = await fetch("/api/zerodha-status");
    const z = await res.json();

    if (z.connected || z.status === "connected") {
      badge.innerHTML = "üü¢ Zerodha CONNECTED";
      badge.className =
        "px-3 py-1 text-xs font-semibold rounded-full bg-green-600/20 text-green-400 shadow shadow-green-500/20";
    } else {
      badge.innerHTML = "üî¥ Zerodha DISCONNECTED";
      badge.className =
        "px-3 py-1 text-xs font-semibold rounded-full bg-red-600/20 text-red-400 shadow shadow-red-500/20";
    }
  } catch (e) {
    badge.innerHTML = "üî¥ Zerodha DISCONNECTED";
    badge.className = "px-3 py-1 text-xs font-semibold rounded-full bg-red-600/20 text-red-400";
  }
}

function updateMarketBadge(marketOpen){
  const badge = $("market-badge");
  if(marketOpen){
    badge.innerText = "üü¢ Market OPEN";
    badge.className = "px-3 py-1 text-xs rounded-full bg-green-600/20 text-green-400";
  } else {
    badge.innerText = "üî¥ Market CLOSED";
    badge.className = "px-3 py-1 text-xs rounded-full bg-red-600/20 text-red-400";
  }
}

/**
 * Alerts gate:
 * - Freeze window me polling OFF
 * - 09:00 ke baad polling ON (market open ho ya na ho)
 */
function manageAlertsPolling(){
  if(isAlertFreezeWindow()){
    stopAlertsPolling();
    return;
  }
  startAlertsPolling();
}

function checkMarketStatus(){
  fetch("/api/market-status")
    .then(r => r.json())
    .then(d => {
      updateMarketBadge(!!d.market_open);
      // ‚úÖ independent alert gate (your requirement)
      manageAlertsPolling();
    })
    .catch(()=> {
      // even if api fails, still apply time gate
      manageAlertsPolling();
    });
}

/* ---------- WS START ---------- */
function startTickWS(){
  if(TICK_WS && TICK_WS.readyState <= 1) return;

  setWs(false,"WS: Connecting");
  TICK_WS = new WebSocket(wsUrl());

  TICK_WS.onopen = () => {
    WS_READY = true;
    setWs(true,"WS: LIVE");
  };

  TICK_WS.onclose = () => {
    WS_READY = false;
    setWs(false,"WS: Reconnecting");
    setTimeout(startTickWS, WS_RETRY);
  };

  TICK_WS.onerror = () => {
    try{ TICK_WS.close(); }catch{}
  };

  TICK_WS.onmessage = ev => {
    let d;
    try{ d = JSON.parse(ev.data); }catch{ return; }

    // snapshot support
    if(d.type === "snapshot" && Array.isArray(d.ticks)){
      for(const t of d.ticks){
        if(!t.symbol) continue;
        TICK_BUFFER[String(t.symbol).toUpperCase()] = t;
      }
      if(!TICK_FLUSH_TIMER){
        TICK_FLUSH_TIMER = setTimeout(flushTickUI, 250);
      }
      return;
    }

    if(!d.symbol) return;
    TICK_BUFFER[String(d.symbol).toUpperCase()] = d;
    if(!TICK_FLUSH_TIMER){
      TICK_FLUSH_TIMER = setTimeout(flushTickUI, 250);
    }
  };
}

/* ---------- NO-BLINK TICK FLUSH (updates all cells by data-sym) ---------- */
function setTextIfChanged(el, txt){
  if(!el) return;
  if(el.textContent !== txt) el.textContent = txt;
}
function calcUnrealizedPnl(side, qty, avg, ltp){
  if(!qty || !avg || !ltp) return 0;
  if(side === "SELL") return (avg - ltp) * qty;
  return (ltp - avg) * qty; // BUY default
}

function paintPnlCell(el, pnl){
  if(!el) return;
  el.classList.remove("text-emerald-300","text-red-300","text-slate-200");
  if(pnl > 0) el.classList.add("text-emerald-300");
  else if(pnl < 0) el.classList.add("text-red-300");
  else el.classList.add("text-slate-200");
}


function flushTickUI(){
  for(const sym in TICK_BUFFER){
    const d = TICK_BUFFER[sym];
    const ltp  = Number(d.ltp||0);
    if(ltp <= 0) continue;

    const prev = Number(d.prev||ltp);
    const open = Number(d.open||prev||ltp);
    const high = Number(d.high||ltp);
    const low  = Number(d.low||ltp);
    const uc = (d.upper_circuit != null && d.upper_circuit !== "") ? Number(d.upper_circuit) : 0;
    const lc = (d.lower_circuit != null && d.lower_circuit !== "") ? Number(d.lower_circuit) : 0;
    
    // ALERTS table: update ALL rows having data-sym=sym
    const nodes = document.querySelectorAll(`[data-sym="${sym}"]`);
    nodes.forEach(node => {
      const field = node.getAttribute("data-field");
      if(!field) return;

      if(field === "ltp") setTextIfChanged(node, ltp.toFixed(2));
      if(field === "uc") setTextIfChanged(node, uc > 0 ? uc.toFixed(2) : "--");
      if(field === "lc") setTextIfChanged(node, lc > 0 ? lc.toFixed(2) : "--");
      if(field === "pct") setTextIfChanged(node, (((ltp-prev)/prev)*100).toFixed(2) + "%");
      if(field === "fo")  setTextIfChanged(node, open ? (((ltp-open)/open)*100).toFixed(2)+"%" : "--");
      if(field === "fh")  setTextIfChanged(node, (((ltp-high)/high)*100).toFixed(2) + "%");
      if(field === "fl")  setTextIfChanged(node, (((ltp-low)/low)*100).toFixed(2) + "%");
      if(field === "tbq") setTextIfChanged(node, String(d.tbq||0));
      if(field === "tsq") setTextIfChanged(node, String(d.tsq||0));
      if(field === "bto") setTextIfChanged(node, String(Math.round(ltp*(d.tbq||0))));
      if(field === "sto") setTextIfChanged(node, String(Math.round(ltp*(d.tsq||0))));
    });

    // LADDER table LTP (no blink)
    const ladderLtp = document.querySelectorAll(`[data-lsym="${sym}"][data-lfield="ltp"]`);
    ladderLtp.forEach(node => setTextIfChanged(node, ltp.toFixed(2)));
    // ===== LIVE LADDER PnL update (continuous) =====
if(LADDER_META[sym]){
  LADDER_META[sym].ltp = ltp;

  const {avg, qty, side} = LADDER_META[sym];
  const pnl = calcUnrealizedPnl(side, qty, avg, ltp);

  const pnlNodes = document.querySelectorAll(`[data-lsym="${sym}"][data-lfield="pnl"]`);
  pnlNodes.forEach(node => {
    setTextIfChanged(node, pnl.toFixed(2));
    paintPnlCell(node, pnl);
  });
}


  }

  TICK_BUFFER = {};
  TICK_FLUSH_TIMER = null;
}

/* ================= ALERTS (NO REBUILD = NO BLINK) ================= */
function startAlertsPolling(){
  if(alertsInterval) return;
  loadAlerts(); // immediate
  alertsInterval = setInterval(() => {
    if(!isAlertFreezeWindow()){
      loadAlerts();
    }
  }, 30000);
}

function stopAlertsPolling(){
  if(alertsInterval) clearInterval(alertsInterval);
  alertsInterval = null;
}

/**
 * Stable render:
 * - if same alert payload signature, DO NOTHING (no rebuild)
 * - if changed, rebuild once
 * - tick updates happen via WS on data-sym cells
 */
async function loadAlerts(){
  try{
    const r = await fetch("/api/alerts");
    const data = await r.json();

    // freeze window => don't change UI (keep last)
    if(isAlertFreezeWindow()){
      return;
    }

    // signature to avoid needless rebuild
    const sig = JSON.stringify(data || []);
    if(LAST_ALERTS_RENDER === sig){
      return;
    }
    LAST_ALERTS_RENDER = sig;

    // rebuild only on change
    const tbody = $("alerts-body");
    let html = "";
    const oldSyms = new Set(subscribed);
    subscribed.clear();

    // if empty, keep last visible rows (don‚Äôt blank => no blink)
    if(!data || data.length === 0){
      // keep old subscription
      subscribed = oldSyms;
      return;
    }

    // unique rows by (scan|time|symbol)
    ALERT_ROW_KEYS.clear();

    data.forEach(a=>{
      (a.stocks || []).forEach(s=>{
        s = String(s||"").toUpperCase();
        if(!s) return;

        subscribed.add(s);
        const key = `${a.scan}|${a.time}|${s}`;
        if(ALERT_ROW_KEYS.has(key)) return;
        ALERT_ROW_KEYS.add(key);

        html += `
        <tr class="hover:bg-slate-800/60">
          <td class="p-3 text-cyan-300">${a.scan}</td>
          <td class="p-3 text-gray-400">${a.time}</td>
          <td class="p-3 font-semibold">${s}</td>

          <td class="p-3 text-cyan-400 tabular-nums" data-sym="${s}" data-field="ltp">--</td>
          <td class="p-3 text-emerald-300 tabular-nums" data-sym="${s}" data-field="uc">--</td>
          <td class="p-3 text-rose-300 tabular-nums" data-sym="${s}" data-field="lc">--</td>
          <td class="p-3 text-center tabular-nums" data-sym="${s}" data-field="pct">--</td>
          <td class="p-3 text-center tabular-nums" data-sym="${s}" data-field="fo">--</td>
          <td class="p-3 text-center tabular-nums" data-sym="${s}" data-field="fh">--</td>
          <td class="p-3 text-center tabular-nums" data-sym="${s}" data-field="fl">--</td>

          <td class="p-3 tabular-nums" data-sym="${s}" data-field="tbq">--</td>
          <td class="p-3 tabular-nums" data-sym="${s}" data-field="tsq">--</td>
          <td class="p-3 text-green-400 tabular-nums" data-sym="${s}" data-field="bto">--</td>
          <td class="p-3 text-red-400 tabular-nums" data-sym="${s}" data-field="sto">--</td>

          <td class="p-3">
            <button onclick="openTradeModal('${s}','BUY')" class="bg-green-600 px-2 py-1 rounded">BUY</button>
            <button onclick="openTradeModal('${s}','SELL')" class="bg-red-600 px-2 py-1 rounded ml-1">SELL</button>
          </td>
        </tr>`;
      });
    });

    tbody.innerHTML = html;
  }catch(e){
    // ignore
  }
}

/* ================= TRADE MODAL ================= */
function openTradeModal(s,side){
  tmSymbol=s; tmSide=side;
  $("tm-symbol").innerText=s;
  $("tm-side").innerText=side;
  $("tradeModal").classList.remove("hidden");
}
function closeTradeModal(){
  $("tradeModal").classList.add("hidden");
}

async function confirmTrade(){
  const mode = $("ls-mode").value;
  const qtyMode = $("ls-qtymode").value;

  const settings = {
    qty_mode: qtyMode,
    per_trade_capital: parseFloat($("ls-capital").value || "0"),
    per_trade_qty: parseInt($("ls-qty").value || "1"),
    threshold_pct: parseFloat($("ls-threshold").value || "1"),
    stop_loss_pct: parseFloat($("ls-sl").value || "1"),
    trailing_sl_pct: parseFloat($("ls-tsl").value || "1"),
    ladder_cycles: parseInt($("ls-cycles").value || "1"),
    max_adds_per_leg: parseInt($("ls-maxadds").value || "2"),
  };

  fetch("/api/ladder/start", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      symbol: tmSymbol,
      side: tmSide,
      settings_mode: mode,
      settings: settings
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.error){
      showMsg("‚ùå " + d.error, true);
      return;
    }
    showMsg("‚úÖ Ladder started: " + tmSymbol + " (" + tmSide + ")", false);
    closeTradeModal();
    loadLadderState();
  })
  .catch(()=> showMsg("‚ùå Ladder start failed", true));
}

/* ================= CREDENTIALS ================= */
function openCred(){ credModal.classList.remove("hidden"); }
function closeCred(){ credModal.classList.add("hidden"); }
function saveCred(){
  fetch("/api/save-credentials",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({api_key:api_key.value, api_secret:api_secret.value})
  }).then(()=>closeCred());
}
function connectZerodha(){ window.location="/connect/zerodha"; }
function logout(){ window.location="/logout"; }

/* ================= OVERALL PNL ================= */
function setOverallPnl(val){
  const pnl = Number(val || 0);

  // top bar (agar aap rakhna chahte ho)
  const elTop = document.getElementById("overall-pnl");
  if(elTop) elTop.textContent = pnl.toFixed(2);

  // ‚úÖ Active Ladders pill
  const elBox = document.getElementById("overall-pnl-ladders");
  if(elBox) elBox.textContent = pnl.toFixed(2);

  // ‚úÖ color logic for pill
  const pill = document.getElementById("ladder-pnl-pill");
  if(!pill) return;

  // reset
  pill.classList.remove(
    "bg-emerald-900/20","border-emerald-600/40","text-emerald-300",
    "bg-red-900/20","border-red-600/40","text-red-300",
    "bg-cyan-900/20","border-cyan-600/40","text-cyan-300"
  );

  if(pnl > 0){
    pill.classList.add("bg-emerald-900/20","border-emerald-600/40","text-emerald-300");
  }else if(pnl < 0){
    pill.classList.add("bg-red-900/20","border-red-600/40","text-red-300");
  }else{
    pill.classList.add("bg-cyan-900/20","border-cyan-600/40","text-cyan-300");
  }
}
function setLadderCount(n){
  const el = document.getElementById("ladder-count");
  if(el) el.textContent = String(Number(n||0));
}



/* ================= LADDER STATE (HIDE DONE + CLEAR ON SQUAREOFF ALL) ================= */
function ladderEmptyUI(){
  const tbody = $("ladderRows");
  tbody.innerHTML = `
    <tr>
      <td colspan="13" class="p-16 text-center text-cyan-900/70 italic text-lg">
        No active ladder strategies
      </td>
    </tr>`;
  setOverallPnl(0);
  setLadderCount(0);
}

function loadLadderState(){
  fetch("/api/ladder/state")
    .then(r=>r.json())
    .then(rows=>{
      const tbody = $("ladderRows");
      if(!rows || rows.length===0){
        ladderEmptyUI();
        return;
      }

      // ‚úÖ filter: DONE + qty=0 rows hide (so Squareoff ke baad clear dikhenga)
      const filtered = rows.filter(s=>{
        const ls = s.leg_state || {};
        const status = String(ls.status||"");
        const qty = Number(ls.qty||0);

        // show if active OR running-like OR qty>0 OR waiting feed
        if(s.active) return true;
        if(qty > 0) return true;
        if(status === "RUNNING" || status === "EXITING") return true;
        if(status === "IDLE" && (ls.reason || "").includes("WAIT")) return true;

        // otherwise hide (DONE etc)
        return false;
      });

      if(filtered.length === 0){
        ladderEmptyUI();
        return;
      }
      setLadderCount(filtered.length);


      // rebuild ladder table (less frequent) but NO LTP blink now (WS updates LTP by data-lsym)
      tbody.innerHTML = "";

      let overall = 0;

      filtered.forEach(s=>{
        const ls = s.leg_state || {};
        const SYM = String(s.symbol || "").toUpperCase();
const avgv = ls.avg_price ? Number(ls.avg_price) : 0;
const qtyv = Number(ls.qty || 0);
const sidev = String(ls.side || "").toUpperCase();

// store latest ladder meta for live pnl calculation
LADDER_META[SYM] = {
  avg: avgv,
  qty: qtyv,
  side: sidev,
  ltp: LADDER_META[SYM]?.ltp || (s.ltp ? Number(s.ltp) : 0),
};

        const hiLo = (ls.side==="BUY")
          ? (ls.highest ? Number(ls.highest).toFixed(2) : "-")
          : (ls.lowest ? Number(ls.lowest).toFixed(2) : "-");

        // LTP shown from WS ticks if available; fallback to API ltp
        const ltp = s.ltp ? Number(s.ltp).toFixed(2) : "-";

        const pnlNum = (ls.unrealized_pnl!=null) ? Number(ls.unrealized_pnl) : 0;
        overall += pnlNum;

        const pnl = pnlNum.toFixed(2);

        let nextAdd = "-";
        let sl = "-";
        let tsl = "-";

        if(ls.avg_price && s.settings){
          const avg = Number(ls.avg_price);
          const last = Number(ls.last_add_price || avg);
          const th = Number(s.settings.threshold_pct);
          const slp = Number(s.settings.stop_loss_pct);
          const tslp = Number(s.settings.trailing_sl_pct);

          if(ls.side === "BUY"){
            nextAdd = (last * (1 + th/100)).toFixed(2);
            sl = (avg * (1 - slp/100)).toFixed(2);
            if(ls.highest) tsl = (Number(ls.highest) * (1 - tslp/100)).toFixed(2);
          } else {
            nextAdd = (last * (1 - th/100)).toFixed(2);
            sl = (avg * (1 + slp/100)).toFixed(2);
            if(ls.lowest) tsl = (Number(ls.lowest) * (1 + tslp/100)).toFixed(2);
          }
        }

        let st = ls.status || "UNKNOWN";
        if(ls.reason){
          st += " (" + ls.reason + ")";
        }
        let stColor = "text-slate-400";
        if(st.includes("WAIT")) stColor = "text-yellow-400";
        else if(st.startsWith("RUNNING")) stColor = "text-green-400";
        else if(st.startsWith("DONE")) stColor = "text-slate-400";
        else if(st.startsWith("ERROR")) stColor = "text-red-500";
        else if(st.startsWith("EXIT")) stColor = "text-orange-400";

        tbody.innerHTML += `
          <tr>
            <td class="p-3 text-left font-semibold">${s.symbol}</td>
            <td class="p-3 text-center">${(s.cycle_index+1)} / ${s.cycle_total}</td>
            <td class="p-3 text-center">${s.leg}</td>
            <td class="p-3 text-center tabular-nums">${ls.qty || 0}</td>

            <td class="p-3 text-center tabular-nums"
                data-lsym="${String(s.symbol).toUpperCase()}"
                data-lfield="ltp">${ltp}</td>

            <td class="p-3 text-center tabular-nums">${ls.avg_price ? Number(ls.avg_price).toFixed(2) : "-"}</td>
            <td class="p-3 text-center tabular-nums">${hiLo}</td>
            <td class="p-3 text-center text-cyan-400 tabular-nums">${nextAdd}</td>
            <td class="p-3 text-center text-red-400 tabular-nums">${sl}</td>
            <td class="p-3 text-center text-yellow-400 tabular-nums">${tsl}</td>
            <td class="p-3 text-center font-semibold tabular-nums"
    data-lsym="${String(s.symbol).toUpperCase()}" data-lfield="pnl">${pnl}</td>
            <td class="p-3 text-center font-semibold ${stColor}">${st}</td>
            <td class="p-3 text-center">
              <button onclick="squareoffLadder('${s.symbol}')"
                class="bg-yellow-600 hover:bg-yellow-500 px-3 py-1 rounded text-xs font-semibold">
                Squareoff
              </button>
            </td>
          </tr>`;
      });

      setOverallPnl(overall);
    })
    .catch(()=>{});
}

function squareoffLadder(symbol){
  fetch("/api/ladder/squareoff", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({symbol})
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.error){
      showMsg("‚ùå " + d.error, true);
      return;
    }
    showMsg("‚úÖ Squareoff done: " + symbol, false);

    // refresh now
    setTimeout(loadLadderState, 500);
  })
  .catch(()=>showMsg("‚ùå Squareoff failed", true));
}

function killSwitch(){
  if(!confirm("KILL SWITCH: This will square-off ALL positions and stop WS + trading. Continue?")) return;
  fetch("/api/kill-switch", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({enabled:true})
  })
  .then(()=> {
    showMsg("üõë Kill switch activated", true);
    setTimeout(loadLadderState, 700);
  })
  .catch(()=>showMsg("‚ùå Kill switch failed", true));
}

// ‚úÖ Squareoff ALL => clear UI immediately + overall pnl 0
function squareoffAll(){
  if(!confirm("Squareoff ALL positions (MIS Market)? Continue?")) return;

  fetch("/api/squareoff_all", { method:"POST" })
    .then(r => r.json())
    .then(d => {
      if(d.error){
        showMsg("‚ùå " + d.error, true);
        return;
      }
      showMsg(`‚úÖ Squareoff all placed (${d.count})`, false);

      // ‚úÖ immediate clear (your requirement)
      ladderEmptyUI();

      // refresh in background to sync actual state
      setTimeout(() => {
        loadLadderState();
      }, 1500);
    })
    .catch(() => showMsg("‚ùå Squareoff all failed", true));
}

/* ================= MSG ================= */
function showMsg(txt, isErr = false) {
  const box = $("msg-box");
  box.textContent = txt;
  box.className = `px-6 py-3 rounded-xl text-sm font-medium shadow-2xl z-50 transition-all duration-300 ${
    isErr
      ? 'bg-red-900/80 text-red-100 border border-red-700/50'
      : 'bg-emerald-900/80 text-emerald-100 border border-emerald-700/50'
  }`;
  box.classList.remove("hidden");

  setTimeout(() => {
    box.classList.add("opacity-0", "translate-y-4");
    setTimeout(() => box.classList.add("hidden"), 400);
  }, 2800);
}

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded", async ()=>{
  if(!(await checkSession())) return;

  refreshStatus();
  checkMarketStatus();   // also manages alert gate

  startTickWS();         // ‚úÖ ONLY ONE WS

  setInterval(refreshStatus, 5000);
  setInterval(checkMarketStatus, 60000);

  loadLadderState();
  setInterval(loadLadderState, 30000);

  // extra: at exact 09:00 IST window, gate will open automatically on next checkMarketStatus tick
});
</script>

</body>
</html>